   LIST P=18F4550
#include <p18f4550.inc>                
;The high-priority interrupt vector is at 000008h and the low-priority interrupt vector is at 000018h.
   CONFIG FOSC = INTOSCIO_EC
   CONFIG WDT = OFF
   CONFIG MCLRE =OFF
   CONFIG PBADEN = ON
   CONFIG LVP=OFF
   ORG 0X0000
   GOTO MAIN
   
   ORG 0X0008
   GOTO SERVICIOHP   
   
   ORG 0X0018
   CBLOCK 0X20  ;### VARIABLES###
   NUMERO
   REG1
   REG2
   WTEMP
   UNIDAD ;0X24
   DECENA ;0X25
   CENTENA; 0X26
   BANDERAS
   UNIDAD1
   DECENA1
   CENTENA1
   BANDERA2 ;0X2B
   CERO
   UNIDAD2 ;0X2D
   DECENA2; 0X2E
   CENTENA2 ;2F
   
   ENDC
   #DEFINE L1 PORTB,0
   #DEFINE L2 PORTB,1
   #DEFINE L3 PORTB,2
   #DEFINE L4 PORTB,3
   #DEFINE C1 PORTB,4
   #DEFINE C2 PORTB,5
   #DEFINE C3 PORTB,6
   #DEFINE C4 PORTB,7
   #DEFINE RS PORTE,0
   #DEFINE RW PORTE,1
   #DEFINE E PORTE,2
   #DEFINE ENTER BANDERA2,0
   #DEFINE CAMBIO BANDERA2,1
   #DEFINE SM BANDERAS,0
   #DEFINE RST BANDERAS,1
   #DEFINE ML BANDERAS,2
   #DEFINE DV BANDERAS,3
   #DEFINE CP BANDERAS,4
   #DEFINE POT2 BANDERAS,5
   #DEFINE POT BANDERAS,6
   #DEFINE FACT BANDERAS,7
 
   
;Iniciamos:
INIT_OSC
   CLRF OSCTUNE,0
   MOVLW B'01110110'
   MOVWF OSCCON
   RETURN
INIT_PORTS
   MOVLW B'00001111'
   MOVWF LATB
   MOVWF ADCON1
   MOVLW B'11110000'
   MOVWF TRISB
   MOVLW H'0F'
   MOVWF TRISA;CONFIGURAMOS A PARA PRUEBAS
   CLRF TRISD
   CLRF TRISE
   CLRF LATD
   CLRF LATE
   CLRF LATA
   RETURN
INIT_INTERRUPCIONES
   BSF	INTCON2,7 ; DESHABILITA LAS PULL UPS EN EL PUERTO B
   CLRF INTCON
   BSF INTCON,7; HABILITAMOS EL GLOBAR INTERRUPT
   BSF INTCON,3 ;HABILITAMOS LAS INTERRUPCIONES POR EL PORTB
   BSF INTCON2,0 ; LAS INTERRUPCIONES DEL PUERTO B SERAN DE ALTA PRIORIDAD
   RETURN
INIT_VARIABLES
   CLRF NUMERO
   CLRF CERO
   RETURN
INITS_LCD
   BCF RS
   MOVWF LATD
   BSF E
   CALL RET_20MS
   BCF E
   RETURN
CONFIG_8B
   CALL RET_20MS
   MOVLW H'38'
   CALL INITS_LCD
   MOVLW H'06'
   CALL INITS_LCD
   MOVLW H'0E';REALMENTE ES 0C PERO ESTOY PROBANDO PARA VER EL CURSOR
   CALL INITS_LCD
   MOVLW H'01'
   CALL INITS_LCD
   RETURN
DATO
   BSF RS
   MOVWF LATD
   BSF E
   CALL RET_20MS
   BCF E
   RETURN
   
   ORG 0X300
SERVICIOHP 
   MOVWF WTEMP ;PUSH WREG NO FUNCIONA!!!!
   CLRF WREG
   BCF INTCON,7  ; DESHABILITAMOS EL GLOBAR INTERRUPT
   BTFSC C1
   CALL COLUMNA1 ; COMPROBAMOS QUE EL BOTON PRESIONADO ESTA EN LA COLUMNA 1
   BTFSC C2
   CALL COLUMNA2 ; COMPROBAMOS QUE EL BOTON PRESIONADO ESTA EN LA COLUMNA 2
   BTFSC C3
   CALL COLUMNA3 ; COMPROBAMOS QUE EL BOTON PRESIONADO ESTA EN LA COLUMNA 3
   BTFSC C4
   CALL COLUMNA4 ; COMPROBAMOS QUE EL BOTON PRESIONADO ESTA EN LA COLUMNA 4
AR ;ANTI REBOTE DEL TECLADO
   MOVLW .15
   CPFSEQ PORTB
   GOTO AR
   BCF INTCON,0  ; LIMPIA LA BANDERA DE INTERRUPCION POR CAMBIO EN RB
   BCF INTCON,1  ; LIMPIA LA BANDERA DE INTERRUPCION EXTERNA
   BSF INTCON,7  ; HABILITAMOS EL GLOBAR INTERRUPT
   MOVF WTEMP,0 ;NO FUNIONA!!POP WREG
   RETFIE
   
COLUMNA1  
   BCF L1
   BTFSS C1
   MOVLW .49
   BSF L1
   BCF L2
   BTFSS C1
   MOVLW .52
   BSF L2
   BCF L3
   BTFSS C1
   MOVLW .55
   BSF L3
   BCF L4
   BTFSS C1
   GOTO CLEAR; CLEAR
   BSF L4
   BCF C1
   MOVWF NUMERO ;;SE GUARDA EN NUMERO, PARA MOSTRAR PRIMERO Y LUEGO GUARDAR EL NUMERO
   CALL DATO
   CALL GUARDAR
SALIDA
   RETURN
   
COLUMNA2
   BCF L1
   BTFSS C2
   MOVLW .50
   BSF L1
   BCF L2
   BTFSS C2
   MOVLW .53
   BSF L2
   BCF L3
   BTFSS C2
   MOVLW .56
   BSF L3
   BCF L4
   BTFSS C2
   MOVLW .48
   BSF L4
   BCF C2
   MOVWF NUMERO
   CALL DATO
   CALL GUARDAR
   RETURN
   
COLUMNA3
   BCF L1
   BTFSS C3
   MOVLW .51
   BSF L1
   BCF L2
   BTFSS C3
   MOVLW .54
   BSF L2
   BCF L3
   BTFSS C3
   MOVLW .57
   BSF L3
   BCF L4
   BTFSS C3
   GOTO FUNCION_ENTER ;ENTER
   MOVWF NUMERO
   CALL DATO
   CALL GUARDAR
   SALIDA2
   BSF L4
   BCF C3
   RETURN
 
   
COLUMNA4
   BTFSC CAMBIO ;PRUEBA SI CAMBIO ESTA ACTIVO, SI NO ESTA ACTIVO, USA LAS PRIMERAS OPERACIONES
   GOTO OTRO_OPE
   BCF L1
   BTFSS C4
   MOVLW .8
   BSF L1
   BCF L2
   BTFSS C4
   MOVLW .4
   BSF L2
   BCF L3
   BTFSS C4
   MOVLW .2
   BSF L3
   BCF L4
   BTFSS C4
   MOVLW .1
   BSF L4
   GOTO FIN
OTRO_OPE ; EN CASP DE QUE CAMBIO ESTE ACTIVADO, SE VA A ESTA TABLA PARA COMPARACION, POTENCIA Y FACTORIAL
   BCF L1
   BTFSS C4
   MOVLW .128
   BSF L1
   BCF L2
   BTFSS C4
   MOVLW .64
   BSF L2
   BCF L3
   BTFSS C4
   MOVLW .32
   BSF L3
   BCF L4
   BTFSS C4
   MOVLW .16
   BSF L4
FIN
   MOVWF BANDERAS ;ACTIVAMOS LAS BANDERAS
   CALL TAB_OPE	   ; DE AQUI SACAMOS EL CARACTER A MOSTRAR	
   CALL DATO  ; MOSTRAMOS
   MOVF UNIDAD,0  ;YA QUE YA ELEGIMOS LA OPERACION, LO GUARDAMOS EN UNIDAD 1 Y ASI
   MOVWF UNIDAD1
   MOVF DECENA,0
   MOVWF DECENA1
   MOVF CENTENA,0
   MOVWF CENTENA1
   CLRF UNIDAD	; ELIMINAMOS TODO LO GUARDADO EN UNIDAD
   CLRF DECENA
   CLRF CENTENA
   RETURN
RET_200MS ;RETARDO DE 200MS PARA TESTEOS DE 1 SEGUNDO
   MOVLW .254
   MOVWF REG2,1
LOOP_RET200
   MOVLW .254
   MOVWF REG1,1
DECREMENTAR
   DECFSZ REG1,1
   GOTO DECREMENTAR
   DECFSZ REG2,1
   GOTO LOOP_RET200
   RETURN
TESTER_1SG: ;TESTEO PARA EL CAMBIO, ESPERA 0.4 SEGUNDOS CON ENTER PUESTO Y LUEGO ESPERA EL CLEAR PARA ACTIVAR
   BTFSS C3
   GOTO ENTRA
   CALL RET_200MS
   BTFSS C3
   GOTO ENTRA
   CALL RET_200MS
   BTFSS C3 
   GOTO ENTRA
   BCF L1
   BCF L2 ;SE ELIMINAN LAS DEMAS FILAS PARA QUE NO ESTORBEN
   BCF L3
LOOP_AS ;; ESPERA EL CLEAR, SI SE SUELTA EL ENTER, IGUAL SE SALE
   BTFSS C3
   GOTO ENTRA
   BTFSS C1
   GOTO LOOP_AS
   BTG CAMBIO
   BSF L1
   BSF L2
   BSF L3
   GOTO SALIDA2
   
TESTER_CLEAR_1SG ;; SE ESPERA 1 SEGUNDO PARA BORRAR TODA LA PANTALLA
   BTFSS C1
   GOTO BORRAR
   CALL RET_200MS
   BTFSS C1
   GOTO BORRAR
   CALL RET_200MS
   BTFSS C1 
   GOTO BORRAR
   CALL RET_200MS
   BTFSS C1
   GOTO BORRAR
   CALL RET_200MS
   BTFSS C1
   GOTO BORRAR
   CALL RET_200MS
   CALL RET_200MS
   GOTO INICIO
  
FUNCION_ENTER
   BSF L4
   GOTO TESTER_1SG
   ENTRA	; SI NO SE DURA 1 SEGUNDO EN ENTER, VA AQUI
   BSF ENTER	
   MOVLW H'C1'		
   CALL INITS_LCD	; LE LLEVAMOS W COMO INSTRUCCION A LA LCD PARA MOVERNOS A LA SEGUNDA LINEA
   MOVLW .61
   CALL DATO	;LLEVAMOS EL =, COMO DATO 
   MOVF UNIDAD,0  ;YA QUE YA LE DIMOS ENTER, LO GUARDAMOS EN UNIDAD2Y ASI
   MOVWF UNIDAD2
   MOVF DECENA,0
   MOVWF DECENA2
   MOVF CENTENA,0
   MOVWF CENTENA2
   CLRF UNIDAD	; ELIMINAMOS TODO LO GUARDADO EN UNIDAD
   CLRF DECENA
   CLRF CENTENA
   GOTO SALIDA2
TAB_OPE	;PATRON PARA LAS OPERACIONES
   BTFSC SM
   MOVLW .43
   BTFSC RST
   MOVLW .45
   BTFSC ML
   MOVLW .42
   BTFSC DV
   MOVLW .47
   BTFSC CP
   MOVLW .34
   BTFSC POT2
   MOVLW .253
   BTFSC POT
   MOVLW .94  ;ES UNAS COMILLAS PORQUE NO HAY EL CUADRADO A LA DOS, HABRA QUE AGREGAR UN ^2, ASI
   BTFSC FACT
   MOVLW .33
   RETURN
GUARDAR
   MOVLW H'30'	
   SUBWF NUMERO,1 ; A NUMERO LE QUITA EL H.30 PARA QUE QUEDE EL NUMERO DECIMAL
   CALL RODAR	; RODAMOS Y GUARDAMOS EN UNIDAD
   MOVF NUMERO,0
   MOVWF UNIDAD
   RETURN
RODAR
   MOVF DECENA,0
   MOVWF CENTENA
   MOVF UNIDAD,0
   MOVWF DECENA
   RETURN
CLEAR
   BSF L4
   GOTO TESTER_CLEAR_1SG ;TESTEA SI ES 1G PARA REINICIAR
   BORRAR
   MOVLW H'10' ;SE DEVUELVE UN PASO A LA IZQUIERDA
   CALL INITS_LCD
    MOVLW .0 	; AGREGA UN CARCTER NULO " "
    CALL DATO
   MOVLW H'10' ;LO DEJA NUEVAMENTE DONDE SE BORRO
   CALL INITS_LCD
   BCF C1
   GOTO SALIDA    
   
RET_20MS ;RETARDO  DE 20MS PARA LA PANTALLA LCD
   MOVLW .28
   MOVWF REG2,1
LOOP_RET20
   MOVLW .254
   MOVWF REG1,1
DECREMENTAR2
   DECFSZ REG1,1
   GOTO DECREMENTAR2
   DECFSZ REG2,1
   GOTO LOOP_RET20
   RETURN
MOSTRAR_RESULTADO
   MOVF CENTENA,0
   CPFSLT CERO ; TESTEA SI CENTENA ES 0
   GOTO DEC 	; EN CASO DE QUE SI SEA 0, NO MUESTRA NADA Y SE VA A DECENA
   ADDLW H'30' ; EN CASO DE QUE NO SEA 0, SE LE SUMA H.30 PARA LLEVAR EL NUMERO A ASCII Y ASI MOSTRATLO
   CALL DATO   ;;LEVA EL NUMERO A LA PANTALLA
   DEC
   MOVLW .0 
   CPFSGT CENTENA ;COMPARAMOS CON CENTENA, SI CENTENA ES 0
   CPFSEQ DECENA  ; SI CENTENA ES 0, PREGUNTAMOS SI DECENA TAMBIEN LO ES. PARA NO MOSTRAR CEROS
   GOTO MOSTRAR_DEC ;EN CASO DE QUE CENTENA NO SEA 0, MUESTRA LO QUE HAYA EN DECENA, ASI SEA 0
   GOTO UNI	;SI DECENA ES 0, NO LO MUESTRA
MOSTRAR_DEC
   MOVF DECENA,0
   ADDLW H'30'
   CALL DATO
   UNI
   MOVF UNIDAD,0 ; MUESTRA LO QUE HAYA EN UNIDAD, ASI SEA 0
   ADDLW H'30' 
   CALL DATO
RETURN
   
MAIN
   CALL INIT_OSC
   CALL INIT_PORTS
   CALL INIT_INTERRUPCIONES
INICIO
   CALL CONFIG_8B ;AQUI SE CONFIGURA EN MODO 8 BITS
   CALL INIT_VARIABLES 
WORM_HOLE 
   BTFSS ENTER
   GOTO WORM_HOLE
   BCF ENTER
   BCF INTCON,7 ;SE DESACTIVAN LAS INTERRUPCIONES PARA QUE SE PUEDA SUMAR EN PAZ
  
   ;AQUI DEBERIA PROBAR LA BANDERA DE LAS OPERACIONES Y REALIZARLAS 
  ;DEBERIA OPERAR Y GUARDAR EN UNIDAD DECENA Y CENTENA 
  ;DESPUES LLAMAR A MOSTRAR_RESULTADO PARA MOSTRAR ESO
   CALL MOSTRAR_RESULTADO ;<<<< AQUI SE VA A MOSTRAR UNIDAD, DECENA Y CENTENA
   BSF INTCON,7
   END
   
   

